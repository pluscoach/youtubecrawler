# YouTube Analyzer 프로젝트 개선 기록 v2

## 프로젝트 개요
- **목적**: 유튜브 영상을 분석해서 자동매매 관련 콘텐츠 제작에 활용
- **스택**: FastAPI (백엔드) + Next.js/TypeScript (프론트엔드) + Supabase (DB) + Claude API

---

## 1. 아키텍처 설계

### 단계별 분리 구조
```
[1단계 - 자동 실행] 링크 입력 시
├── 📺 영상 분석 (요약, 키포인트, 인용문)
└── ⚖️ 소재 적합성 판단 (★1~5)

[2단계 - 수동 실행] 비판적 분석 버튼
└── 🔥 비판적 분석 (숨겨진 전제, 모순, 후킹 포인트)

[3단계 - 수동 실행] 추가 분석 버튼
└── 🎬 영상 제작 가이드 (썸네일, 제목, 대본, 소스)
```

### 효과
- 필요한 분석만 실행 → API 비용 절감
- 부적합 영상은 1단계에서 필터링

---

## 2. 배포 환경 구성

### 서비스 구성
| 서비스 | 플랫폼 | URL |
|--------|--------|-----|
| 프론트엔드 | Vercel | https://youtubecrawler-ie6g.vercel.app |
| 백엔드 | Render | https://youtube-analyzer-ap.onrender.com |
| DB | Supabase | PostgreSQL |

### CORS 설정 (main.py)
```python
allow_origins=[
    settings.frontend_url,
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "https://youtubecrawler-ie6g.vercel.app",  # 배포 도메인 추가 필수!
],
```

### 환경변수
- **로컬**: `backend/.env` 파일 (Git에 올리지 않음)
- **배포**: Render/Vercel 대시보드에서 직접 설정

---

## 3. TypeScript 타입 에러 해결 패턴

### 자주 발생하는 에러와 해결법

**1. API 응답 데이터가 undefined일 수 있음**
```typescript
// ❌ 에러
setItems(response.data);

// ✅ 해결
setItems(response.data || []);
setTotal(response.total || 0);
```

**2. Optional 필드 접근**
```typescript
// ❌ 에러
source.quote.substring(0, 50)

// ✅ 해결
source.quote?.substring(0, 50) || ''
```

**3. 컴포넌트 Props 타입**
```typescript
// ❌ 에러: text가 undefined일 수 있음
function SourceLink({ text }: { text: string }) { ... }

// ✅ 해결: optional로 변경하고 내부에서 처리
function SourceLink({ text }: { text?: string }) {
  const displayText = text || '-';
  ...
}
```

**4. 타입 정의 시 모든 필드 고려**
```typescript
// API 응답 구조에 맞게 모든 optional 필드 정의
export interface AnalysisResult {
  id: string;
  summary: string;
  critical_analysis?: CriticalAnalysis;  // optional
  additional_analysis?: AdditionalAnalysisResult;  // optional
}
```

### 빌드 테스트 필수
```bash
# 로컬에서 타입 에러 확인 후 push
cd frontend && npm run build
```

---

## 4. 새 컴퓨터로 프로젝트 이동 시

### 자주 발생하는 문제

**1. Python 패키지 설치 실패 (pyroaring 빌드 오류)**
```bash
# 해결: 개별 패키지 설치
python -m pip install youtube-transcript-api
python -m pip install google-api-python-client
python -m pip install anthropic httpx python-multipart tavily-python
python -m pip install supabase postgrest realtime websockets --no-deps
python -m pip install pyiceberg cachetools sortedcontainers mmh3 --no-deps
```

**2. 프론트엔드 node_modules 없음**
```bash
cd frontend && npm install
```

**3. .env 파일 없음**
- Git에 올리지 않으므로 수동 생성 필요
- 기존 컴퓨터에서 복사하거나 각 서비스 대시보드에서 키 확인

**4. lib/api.ts가 Git에 안 올라감**
- `.gitignore`에 `lib/` 패턴이 있으면 `frontend/src/lib/`도 무시됨
- 해결: `.gitignore`에 `!frontend/src/lib/` 추가

### 체크리스트
- [ ] Python 3.10+ 설치됨
- [ ] Node.js 18+ 설치됨
- [ ] `backend/.env` 파일 생성됨
- [ ] `pip install -r requirements.txt` 완료
- [ ] `npm install` 완료
- [ ] `frontend/src/lib/api.ts` 존재함

---

## 5. 출처 검증 (Tavily API)

### 문제
- Claude가 출처 언급하지만 실제 URL 없음
- "고용노동부 근로실태조사" 같은 텍스트만 있음

### 해결
```
Claude 분석 → 출처 텍스트 추출 → Tavily로 실제 URL 검색 → 검증 표시
```

| 상태 | UI 표시 |
|------|---------|
| 검증됨 | ✓ 파란색 링크 |
| 미검증 | 🔍 Google 검색 링크 |

### Tavily API
- 월 1,000회 무료
- 자동 결제 없음 (안전)

---

## 6. 프롬프트 설계 원칙

### 나쁜 예
```
"썸네일 문구 추천해줘"
```

### 좋은 예
```
"아래 조건으로 썸네일 문구 5개 추천해줘.
- 글자 수: 10자 이내
- 형식: 의문형 or 충격형
- 포함 요소: 후킹 포인트에서 추출한 핵심 키워드
- 출력: JSON 형식 (type, text, basis, click_psychology)"
```

### 원칙
1. **구체적 조건** - 글자 수, 개수, 형식 명시
2. **출력 형식** - JSON 스키마 제공
3. **맥락 연결** - 앞서 분석한 데이터 활용 명시
4. **근거 요청** - 왜 그렇게 추천했는지 이유 포함

---

## 7. 모델 분리 전략

| 단계 | 모델 | 이유 |
|------|------|------|
| 1단계 (영상 분석) | Haiku | 빠른 필터링, 저렴 |
| 2단계 (비판적 분석) | Sonnet | 퀄리티 필요 |
| 3단계 (추가 분석) | Sonnet | 퀄리티 필요 |

---

## 8. 프로젝트 문서화

### 필수 문서
| 파일 | 용도 |
|------|------|
| `CLAUDE.md` | 프로젝트 규칙, 배포 URL, 수정 시 주의사항 |
| `시작.md` | 로컬 서버 실행 가이드 |
| `데스크탑에서 노트북 옮길 때.md` | 환경 이동 시 가이드 |

### CLAUDE.md 필수 내용
- 배포 환경 URL
- 코드 수정 후 필수 작업 (빌드 테스트)
- 환경변수 관리 방법

---

## 9. Git 워크플로우

### 수정 후 배포 과정
```bash
# 1. 코드 수정

# 2. 프론트엔드 빌드 테스트
cd frontend && npm run build

# 3. 에러 없으면 커밋 & 푸시
git add -A
git commit -m "변경 내용"
git push

# 4. 자동 배포됨 (Vercel, Render)
```

### 커밋 메시지 컨벤션
```
Fix type error in ResultCard
Add Vercel domain to CORS
Update api.ts types for AdditionalAnalysis
```

---

## 10. 자주 쓰는 명령어

### 로컬 개발
```bash
# 백엔드
cd backend && uvicorn app.main:app --reload

# 프론트엔드
cd frontend && npm run dev

# 빌드 테스트
cd frontend && npm run build
```

### Git
```bash
git status
git add -A
git commit -m "메시지"
git push
```

### 패키지 설치
```bash
# Python
python -m pip install 패키지명

# Node.js
npm install
```

---

## 핵심 교훈

1. **타입 안전성** - TypeScript 에러는 빌드 전에 반드시 수정
2. **환경 분리** - .env는 Git에 올리지 않고, 배포 환경에서 직접 설정
3. **CORS 설정** - 배포 도메인 추가 잊지 말 것
4. **문서화** - 프로젝트 규칙과 실행 방법 문서로 정리
5. **빌드 테스트** - push 전에 항상 `npm run build` 실행
6. **단계별 분리** - 모든 분석을 한 번에 하지 않고 필요한 것만 실행
7. **출처 검증** - AI 응답의 출처는 반드시 검증 (Tavily API)

---

*마지막 업데이트: 2026-01-08*
