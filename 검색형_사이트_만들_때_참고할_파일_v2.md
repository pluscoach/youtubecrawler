# YouTube Analyzer 프로젝트 개선 기록 v2

## 버전 1에서 추가된 내용
이 문서는 버전 1의 내용을 기반으로, **배포 과정에서 겪은 문제들과 해결책**을 추가한 버전입니다.

---

## 11. 배포 환경 구성

### 선택한 스택

| 서비스 | 용도 | 비용 |
|--------|------|------|
| **Vercel** | 프론트엔드 (Next.js) | 무료 |
| **Render** | 백엔드 (FastAPI) | 무료 |
| **Supabase** | 데이터베이스 | 무료 |

### 왜 이 조합인가?

| 옵션 | 장점 | 단점 | 결론 |
|------|------|------|------|
| GitHub Pages | 완전 무료 | 정적 사이트만 가능, 백엔드 불가 | ❌ |
| Railway | 빠른 배포 | 월 $5 크레딧 빠르게 소진 | ❌ |
| Vercel + Render | 둘 다 무료 티어 | Render 무료는 15분 후 슬립 | ✅ 선택 |

### 배포 URL

```
프론트엔드: https://youtubecrawler-ie6g.vercel.app
백엔드: https://youtube-analyzer-ap.onrender.com
```

---

## 12. Render 백엔드 배포 문제들

### 문제 1: Language가 Docker로 설정됨

**증상**: Render가 Python이 아닌 Docker로 감지

**해결**: 
- Render 대시보드 → Settings → Language를 **Python 3**로 수동 변경

---

### 문제 2: gunicorn not found

**증상**:
```
bash: line 1: gunicorn: command not found
Exited with status 127
```

**원인**: Render가 기본으로 gunicorn을 실행하려 하는데, requirements.txt에 없음

**해결 1** - requirements.txt에 추가:
```
gunicorn
```

**해결 2** - Start Command 변경 (Settings에서):
```
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

**교훈**: FastAPI는 uvicorn을 쓰는데, Render 기본 설정은 gunicorn임. Start Command를 명시적으로 설정해야 함.

---

### 문제 3: ModuleNotFoundError: No module named 'your_application'

**증상**: Render가 `your_application.wsgi`를 찾으려 함

**원인**: Start Command가 기본값(gunicorn your_application.wsgi)으로 되어 있음

**해결**: Settings → Start Command를 이렇게 변경:
```
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

---

### 문제 4: Root Directory 설정

**주의사항**: 프로젝트 구조가 monorepo일 경우 (backend/, frontend/ 분리)

**설정**:
- Root Directory: `backend`
- 이렇게 해야 requirements.txt를 제대로 찾음

---

## 13. Vercel 프론트엔드 배포 문제들

### 문제 1: TypeScript 타입 에러

**증상**:
```
Type error: Argument of type 'HistoryItem[] | undefined' is not assignable to parameter of type 'SetStateAction<HistoryItem[]>'.
```

**원인**: API 응답이 undefined일 수 있는데 타입 처리 안 함

**해결**: optional 처리 추가
```typescript
// Before (에러)
setItems(response.data);

// After (정상)
setItems(response.data || []);
```

**교훈**: TypeScript strict 모드에서는 모든 optional 필드를 명시적으로 처리해야 함.

---

### 문제 2: 여러 파일에서 같은 에러 반복

**증상**: 
- page.tsx 수정 → 빌드 → history/page.tsx 에러
- history/page.tsx 수정 → 빌드 → ResultCard.tsx 에러

**해결**: Claude Code에게 한 번에 처리 요청
```
ResultCard.tsx에 타입 에러가 계속 발생해.

한 번에 모든 타입 에러를 수정해줘:

1. 모든 optional 필드에 ?. 또는 || '' 또는 || [] 추가
2. npm run build로 로컬에서 먼저 테스트해서 에러 없는지 확인
3. 에러 없으면 GitHub에 push

로컬에서 빌드 성공한 후에 push해줘.
```

**교훈**: 배포 전에 **로컬에서 `npm run build` 먼저 실행**해서 타입 에러 확인하기!

---

### 문제 3: 환경변수 미설정

**증상**: 
```
서버 연결에 실패했습니다.
```

**원인**: Vercel에 NEXT_PUBLIC_API_URL 환경변수 없음

**해결**:
1. Vercel 대시보드 → Settings → Environment Variables
2. 추가:
   ```
   NEXT_PUBLIC_API_URL = https://youtube-analyzer-ap.onrender.com
   ```
3. **Redeploy** 필수! (환경변수 추가 후 재배포해야 적용됨)

---

### 문제 4: CORS 에러

**증상**:
```
Ensure CORS response header values are valid
```

**원인**: 백엔드가 Vercel 도메인을 허용하지 않음

**해결**: backend/app/main.py CORS 설정에 Vercel 도메인 추가
```python
origins = [
    "http://localhost:3000",
    "https://youtubecrawler-ie6g.vercel.app",  # 추가
]
```

**교훈**: 프론트엔드 배포 URL을 백엔드 CORS에 추가해야 함. 안 하면 브라우저가 요청 차단.

---

## 14. Render 무료 플랜 특징

### 알아야 할 것

| 특징 | 내용 |
|------|------|
| 슬립 모드 | 15분 미사용 시 서버 자동 종료 |
| 깨어나는 시간 | 약 50초 |
| 자동 배포 | GitHub push 시 자동 재배포 |
| 배포 시간 | 약 2~5분 |

### 서버 깨우기

배포 사이트 접속 전에 백엔드 URL 먼저 접속:
```
https://youtube-analyzer-ap.onrender.com
```

JSON 응답 보이면 서버 준비 완료:
```json
{"message":"YouTube Analyzer API","version":"1.0.0","docs":"/docs"}
```

---

## 15. API 키 관리

### 환경변수 목록

**Render (백엔드)**:
```
ANTHROPIC_API_KEY=sk-ant-api03-...
YOUTUBE_API_KEY=AIza...
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=eyJ...  (service_role 키 사용!)
TAVILY_API_KEY=tvly-dev-...
```

**Vercel (프론트엔드)**:
```
NEXT_PUBLIC_API_URL=https://youtube-analyzer-ap.onrender.com
```

### Supabase 키 주의사항

| 키 종류 | 형태 | 용도 |
|---------|------|------|
| anon key | `eyJ...` | 클라이언트용 (제한적) |
| service_role key | `eyJ...` | 서버용 (전체 권한) ✅ |
| publishable key | `sb_publishable_...` | ❌ 사용하면 안 됨 |

**교훈**: `sb_publishable_...`로 시작하는 키 쓰면 에러남. `eyJ...`로 시작하는 service_role 키 사용!

---

## 16. 노트북/새 환경 설정

### 문제: 데스크탑에선 됐는데 노트북에선 안 됨

**원인**: 
1. Python 패키지 설치 안 됨
2. .env 파일 없음 (GitHub에 안 올라감)

### 해결

**1단계 - 패키지 설치**:
```bash
cd backend
pip install -r requirements.txt
```

**2단계 - .env 파일 생성**:
```bash
# backend/.env 파일 만들기
ANTHROPIC_API_KEY=sk-ant-api03-...
YOUTUBE_API_KEY=AIza...
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=eyJ...
TAVILY_API_KEY=tvly-dev-...
```

**교훈**: .env 파일은 .gitignore에 있어서 GitHub에 안 올라감. 새 환경마다 수동으로 만들어야 함.

---

## 17. 로컬 개발 워크플로우

### 로컬에서 먼저 테스트

```bash
# 터미널 1 - 백엔드
cd backend
uvicorn app.main:app --reload

# 터미널 2 - 프론트엔드
cd frontend
npm run dev
```

접속: http://localhost:3000

### 배포 전 체크리스트

1. ✅ 로컬에서 `npm run build` 성공하는지 확인
2. ✅ 타입 에러 없는지 확인
3. ✅ 로컬에서 기능 테스트
4. ✅ git push → 자동 배포
5. ✅ Render 서버 깨우기 (50초 대기)
6. ✅ 배포 사이트 테스트

---

## 18. 자동 배포 흐름

```
VS Code에서 수정 
    ↓
git add . && git commit -m "메시지" && git push
    ↓
GitHub에 반영
    ↓
Vercel 자동 감지 → 프론트 재배포 (1~2분)
Render 자동 감지 → 백엔드 재배포 (2~5분)
    ↓
배포 완료 → 사이트 반영
```

---

## 19. Claude Code 활용 팁

### 프로젝트 규칙 파일 만들기

CLAUDE.md 파일을 프로젝트 루트에 만들어서 규칙 저장:

```markdown
# YouTube Analyzer 프로젝트 규칙

## 배포 환경
- 프론트엔드: https://youtubecrawler-ie6g.vercel.app
- 백엔드: https://youtube-analyzer-ap.onrender.com

## 코드 수정 후 필수 작업
1. `cd frontend && npm run build`로 빌드 테스트
2. 타입 에러 없는지 확인 후 push
```

### 서버 실행 명령어

Claude Code에게:
```
백엔드, 프론트엔드 둘 다 실행하고 localhost:3000 브라우저로 열어줘
```

---

## 20. 문제 해결 요약

| 문제 | 원인 | 해결 |
|------|------|------|
| gunicorn not found | requirements.txt에 없음 | gunicorn 추가 또는 Start Command 변경 |
| TypeScript 타입 에러 | optional 필드 처리 안 함 | `?.` 또는 `\|\| []` 추가 |
| 서버 연결 실패 | 환경변수 없음 | Vercel에 NEXT_PUBLIC_API_URL 추가 |
| CORS 에러 | 백엔드가 프론트 도메인 차단 | main.py CORS에 도메인 추가 |
| Invalid API key | 잘못된 키 또는 캐싱 | .env 확인 + 서버 재시작 |
| 새 환경에서 안 됨 | 패키지/env 파일 없음 | pip install + .env 생성 |

---

## 21. 다음 프로젝트에 적용할 것

### 배포 전 준비

1. **.gitignore 확인** - .env는 올리면 안 됨
2. **환경변수 문서화** - 어떤 키가 필요한지 README에 기록
3. **CORS 설정 미리** - 배포할 도메인을 미리 추가해두거나 `*` 사용 (개발용)

### TypeScript 프로젝트

1. **strict 모드** - 모든 optional 필드 명시적 처리
2. **배포 전 빌드** - `npm run build` 로컬에서 먼저 실행
3. **한 번에 수정** - 에러 하나씩 고치지 말고 전체 스캔 후 일괄 수정

### 무료 호스팅 사용 시

1. **슬립 모드 인지** - Render 무료는 15분 후 꺼짐
2. **콜드 스타트 대응** - 첫 요청 느림 (50초), 로딩 UI 필요
3. **업그레이드 경로** - 나중에 유료로 전환 가능한지 확인

---

## 22. YouTube 자막 추출 IP 차단 문제

### 문제 발견

배포 후 분석 실행하니 에러 발생:
```
자막 목록 조회 실패: Could not retrieve a transcript for the video!
YouTube is blocking requests from your IP.
You are doing requests from an IP belonging to a cloud provider (like AWS, Google Cloud Platform, Azure, etc.)
```

### 원인

- **youtube-transcript-api**는 YouTube 페이지를 직접 스크래핑함
- YouTube는 클라우드 서버 IP (AWS, GCP, Azure, Render 등) 대부분 차단
- 로컬에서는 집 IP라서 됨, 배포하면 서버 IP라서 차단됨

### 이걸 미리 알 수 있었나?

**솔직히 배포해보기 전까진 몰랐음.**
- 로컬에서는 완벽하게 작동
- 클라우드 IP 차단은 배포 후에야 발견

### 다른 서비스들은 어떻게 하나?

| 서비스 | 방식 |
|--------|------|
| **Glasp, YouTube Summary** | 크롬 확장 → 사용자 브라우저에서 실행 → 차단 안 됨 |
| **Lilys AI** | Residential Proxy 사용 (추정) |
| **일부 서비스** | Whisper로 음성 인식 (자막 아닌 오디오 변환) |

### 해결 옵션

| 방법 | 비용 | 설명 |
|------|------|------|
| **로컬 사용** | 무료 | 집 IP는 차단 안 됨 ✅ |
| **Webshare Residential Proxy** | 월 $3.50~6 | youtube-transcript-api 공식 지원 |
| **Whisper 음성인식** | 분당 $0.006 | 자막 없는 영상에도 작동 |

### 선택한 해결책: 로컬/배포 분기 처리

**로컬**: 프록시 없이 무료로 사용
**배포**: 나중에 Webshare 연동 (필요 시)

### 코드 수정

```python
# backend/app/services/transcript.py

import os
from youtube_transcript_api import YouTubeTranscriptApi
from youtube_transcript_api.proxies import WebshareProxyConfig

def get_transcript_api():
    use_proxy = os.getenv("USE_PROXY", "false").lower() == "true"
    
    if use_proxy:
        proxy_username = os.getenv("WEBSHARE_USERNAME")
        proxy_password = os.getenv("WEBSHARE_PASSWORD")
        
        if proxy_username and proxy_password:
            return YouTubeTranscriptApi(
                proxy_config=WebshareProxyConfig(
                    proxy_username=proxy_username,
                    proxy_password=proxy_password,
                )
            )
    
    return YouTubeTranscriptApi()
```

### 환경변수 설정

**로컬 (.env)**: `USE_PROXY` 없거나 `false` → 무료
**Render (배포)**: 나중에 추가
```
USE_PROXY=true
WEBSHARE_USERNAME=xxx
WEBSHARE_PASSWORD=xxx
```

### 교훈

1. **클라우드 배포 시 외부 API 스크래핑은 IP 차단 위험**
2. **공식 API vs 스크래핑 라이브러리 차이 인지**
3. **로컬/배포 환경 분기 처리 미리 설계**
4. **배포 전 "이 라이브러리가 클라우드에서 작동하나?" 검색 필요**

---

## 23. 로컬 사용 가이드

### Claude Code에게 요청

```
백엔드, 프론트엔드 둘 다 실행하고 localhost:3000 브라우저로 열어줘
```

### 수동 실행 (터미널)

**터미널 1 - 백엔드**:
```bash
cd backend
uvicorn app.main:app --reload
```

**터미널 2 - 프론트엔드**:
```bash
cd frontend
npm run dev
```

**브라우저**: http://localhost:3000

### 로컬 vs 배포 비교

| 항목 | 로컬 | 배포 |
|------|------|------|
| **URL** | localhost:3000 | youtubecrawler-ie6g.vercel.app |
| **자막 추출** | ✅ 작동 (집 IP) | ❌ 차단 (서버 IP) |
| **비용** | 무료 | 프록시 필요 시 월 $3.50~6 |
| **속도** | 빠름 | 콜드 스타트 50초 |
| **사용 목적** | 개인 사용, 개발 | 외부 공개, 서비스 |

### 권장 워크플로우

1. **평소**: 로컬에서 무료로 사용
2. **코드 수정**: Claude Code로 수정 → 로컬 테스트
3. **배포 필요 시**: push → 자동 배포 (자막은 프록시 연동 후)

---

## 24. 배포 사이트 자막 기능 살리기 (나중에)

### Webshare 가입 및 설정

1. https://webshare.io 가입
2. **Residential Proxy** 구매 (월 $3.50~6)
   - ⚠️ "Proxy Server"나 "Static Residential" 아님!
3. Proxy Username, Password 복사

### Render 환경변수 추가

```
USE_PROXY=true
WEBSHARE_USERNAME=your-username
WEBSHARE_PASSWORD=your-password
```

### 재배포

환경변수 추가 후 자동 재배포되면 배포 사이트에서도 자막 추출 작동!

---

## 마무리

버전 2에서 추가된 핵심 교훈:

1. **배포는 로컬과 다르다** - 환경변수, CORS, 빌드 과정이 다름
2. **TypeScript strict 모드** - 로컬에선 되는데 빌드에서 실패할 수 있음
3. **무료 호스팅 한계** - 슬립 모드, 콜드 스타트 이해하기
4. **문서화 중요** - .env 예시, 배포 URL, 실행 방법 기록해두기
5. **로컬 테스트 먼저** - push 전에 빌드 성공 확인!
6. **스크래핑 라이브러리 주의** - 클라우드 IP 차단될 수 있음
7. **로컬/배포 분기 설계** - 환경에 따라 다르게 동작하도록 미리 설계
8. **비용 최적화** - 로컬 무료 + 배포 유료 분리 가능
